pipeline {
    agent any

    environment {
        APP_DIR        = 'lab3-reatiltech-app'
        IMAGE_NAME     = 'retailtech/product-service'
        LOCAL_REGISTRY = 'localhost:5000'
        IMAGE_TAG      = "${env.BUILD_NUMBER}-${env.GIT_COMMIT ? env.GIT_COMMIT.take(7) : 'local'}"
        COMPOSE_NET    = 'project-dev-ops_devops-network'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 15, unit: 'MINUTES')
        disableConcurrentBuilds()
        timestamps()
    }

    stages {

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Checkout') {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            steps {
                script {
                    echo 'ğŸ” Clonando repositorio...'
                    checkout scm
                    env.GIT_COMMIT_MSG = sh(
                        script: 'git log -1 --pretty=%B',
                        returnStdout: true
                    ).trim()
                    echo "ğŸ“ Commit: ${env.GIT_COMMIT_MSG}"
                    echo "ğŸ”– Tag de imagen: ${IMAGE_TAG}"
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Install & Test') {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            steps {
                echo 'ğŸ§ª Ejecutando tests dentro de contenedor Node.js...'
                sh """
                    docker run --rm \
                        -v \$(pwd)/${APP_DIR}:/app \
                        -w /app \
                        node:18-alpine \
                        sh -c "npm install && npm test"
                """
            }
            post {
                always {
                    echo 'ğŸ“Š Tests finalizados'
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('SonarQube Analysis') {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            steps {
                echo 'ğŸ” Analizando calidad del cÃ³digo...'
                withSonarQubeEnv('SonarQube') {
                    sh """
                        docker run --rm \
                            --network ${COMPOSE_NET} \
                            -v \$(pwd)/${APP_DIR}:/usr/src \
                            -e SONAR_HOST_URL=\${SONAR_HOST_URL} \
                            -e SONAR_TOKEN=\${SONAR_AUTH_TOKEN} \
                            sonarsource/sonar-scanner-cli:latest \
                            -Dsonar.projectKey=retailtech-product-service \
                            -Dsonar.projectName='RetailTech Product Service' \
                            -Dsonar.sources=/usr/src \
                            -Dsonar.exclusions='**/node_modules/**,**/coverage/**' \
                            -Dsonar.javascript.lcov.reportPaths=/usr/src/coverage/lcov.info
                    """
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Build Docker Image') {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            steps {
                echo 'ğŸ³ Construyendo imagen Docker...'
                sh """
                    docker build \
                        -t ${LOCAL_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} \
                        -t ${LOCAL_REGISTRY}/${IMAGE_NAME}:latest \
                        --label "build.number=${env.BUILD_NUMBER}" \
                        --label "git.commit=${env.GIT_COMMIT}" \
                        ${APP_DIR}/
                """
                echo "âœ… Imagen: ${IMAGE_NAME}:${IMAGE_TAG}"
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Push to Local Registry') {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            steps {
                echo 'ğŸ“¤ Publicando al registry local (localhost:5000)...'
                sh "docker push ${LOCAL_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
                sh "docker push ${LOCAL_REGISTRY}/${IMAGE_NAME}:latest"
                echo 'âœ… Imagen publicada'
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Deploy') {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            steps {
                echo 'ğŸš€ Desplegando nueva versiÃ³n del product-service...'
                sh """
                    cd \$(pwd) && \
                    docker compose up -d --no-deps product-service
                """
                echo 'âœ… Deployment completado'
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Smoke Tests') {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            steps {
                echo 'ğŸ’¨ Smoke tests...'
                sh """
                    sleep 5
                    curl -sf http://localhost:3000/health | grep -q 'UP' \
                        && echo 'âœ… Health check OK' \
                        || (echo 'âŒ Health check FALLÃ“' && exit 1)

                    curl -sf http://localhost:3000/api/products | grep -q 'id' \
                        && echo 'âœ… API products OK' \
                        || (echo 'âŒ API products FALLÃ“' && exit 1)
                """
            }
        }
    }

    post {
        success {
            echo 'ğŸ‰ Pipeline completado exitosamente!'
            echo 'ğŸ”— Product Service: http://localhost:3000'
            echo 'ğŸ“– Swagger UI:      http://localhost:3000/docs'
            echo 'ğŸ“Š MÃ©tricas:        http://localhost:9090'
            echo 'ğŸ“ˆ Grafana:         http://localhost:3001'
        }
        failure {
            echo 'âŒ Pipeline fallÃ³ â€” revisa los logs arriba'
        }
        always {
            cleanWs()
            sh 'docker image prune -f || true'
        }
    }
}
